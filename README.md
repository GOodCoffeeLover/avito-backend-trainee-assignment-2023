# Что это?

Тестовое задание, которое было реализовано в стиле чистой ахритектуры. API построено почти по REST принципам, кроме ручки работы с ассайнами сегментов на полльзователя, чтобы можно было назначать/убирать несколько сегментов с пользователя, согласно заданию.

# Как запустить?
Есть 3 варианта запуска приложения: локально с postgresql в контейнере, с помощью docker-compose и в kind кластере с помощью хельма.

## Локально
### Запуск
Требуется предустановленный `docker`, `go` и `pg_isready`
``` bash
# Поднимает контейнер с постгрёй, накатывает миграцию 
# и запускает само приложение
make local-up # чтобы остановить приложение нужно нажать ctrl+C

# удаляет ранее поднятый контейнер с постгрёй
make local-down
```

### Запросы к приложению
"Накидать" запросов можно с помощью `make curls`, которая требует `curl` и `jq`.

## Docker compose
### Запуск
Требуется предустановленный `docker` и `docker compose` плагин.
``` bash
# Поднимает контейнеры с постгрёй, накатывает миграцию отдельным контейнером 
# и запускает само приложение отдельным контейнером
make docker-compose-up 

# останавливает и удаляет ранее поднятые контейнеры
make docker-compose-down
```

### Запросы к приложению
"Накидать" запросов можно с помощью `make curls`, которая требует `curl` и `jq`.

## Kubernetes IN Docker
### Запуск
Требуется предустановленный `docker`, `kind`, `kubectl`, `helm`.
``` bash
# Поднимает kind кластер segments-local, собирает и
# копирует на его ноды образа с приложением и миграцией
# и деплоит постгрю стейтфул сетом в одну реплику и само 
# приложение в три реплики растянутые на 3 доступные ноды
make k8s-up 

# удаляет поднятый кластер
make k8s-down
```

### Запросы к приложению
"Накидать" запросов можно с помощью `make k8s-curls`, которая требует `curl`, `jq` и доступность докер сети с локальной машины.
Либо можно отправлять запросы через `kubectl run`:
```bash
kubectl run -i --rm --quiet=true wget-users --image=busybox --restart=Never -- \
  sh -c "wget -qO- segments-api.local/v1/user | xargs echo" 2>/dev/null # подавляем варнинг, что не аттачим контейнер к поду
```
